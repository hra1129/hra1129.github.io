<!DOCTYPE HTML>
<html lang="ja" xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta charset="utf-8">
		<title>HRA's room</title>
		<link href="../mystyle.css" rel="stylesheet" type="text/css">
	</head>
	<body id="contents_main">
		複数の漢字ROM<br>
		<hr>
		≪結論≫
		　(1) FS-A1GTは外付け漢字ROMを利用できない。<br>
		　(2) 漢字ROM内蔵 MSX2 (※ごく一部の規格違反機種を除く) では、漢字ROMカートリッジを1つだけ装着でき、装着するとカートリッジ側が有効になる。<br>
		　(3) FS-A1GT以外の機種では、漢字ROMカートリッジを複数搭載すると故障の原因になる。危険。<br>
		<br>
		<hr>
		MSXの標準漢字ROMは、I/Oポートの D8h～DBh に繋がっています。<br>
		そのため、複数の装着はバス競合によって本体を破壊する恐れがあります。<br>
		<br>
		　　≪ バス競合 ≫<br>
		　　　　例えば、SLOT#1 に漢字ROM-A, SLOT#2 に漢字ROM-B が装着されていたとします。<br>
		　　　　AとBはフォントが異なり、同じ字でも微妙に形が違います。<br>
		　　　　プログラムから漢字フォントが必要になったときに、D8h-D9h にアクセスします。<br>
		　　　　すると、AとBは、どちらも「自分がフォントデータを返すアドレスだ！」と認識して<br>
		　　　　データバスにフォントデータを出力し始めます。<br>
		　　　　データバスの各ビットにフォントの形状が出てきますので、特に形状が違う部分で<br>
		　　　　一方は 1 を示す 5V を、他方は 0 を示す 0V を出力してしまいます。<br>
		　　　　これらは単純に直結しているので、ショートしたような状態になるわけです。<br>
		　　　　同じ値だったとしても、微妙に電圧が異なったりしているので、出力しているつもりの回路に<br>
		　　　　電流が流れ込んでおかしなことが起こるかもしれません。<br>
		<br>
		MSX2以降 (※ごく一部を除く) では、本体に漢字ROMを内蔵している場合、デフォルトでは本体側が<br>
		無効になっており、I/Oポートの F5h の bit0 に 1を書くと第1水準JIS漢字、bit1 に 1を書くと第2水準JIS漢字<br>
		が有効になる仕組みになっています。F5h はBIOSが管理するモノなので、一般のプログラムから読み書きしてはダメです。<br>
		F5h は書き込みONLYで、1を書いたときに有効になるだけです。(0を書いて無効にすることは出来ないと思います。未確認。)<br>
		<br>
		MSXの漢字ROMは、特定の文字が決まった形状であることが決められており、この文字フォントを読み出せれば漢字ROMが<br>
		接続されていると認識します。<br>
		BIOSは、本体側漢字ROMが無効の状態のままで、漢字ROMが装着されているかを調べます。<br>
		装着されていればそのまま、されていなければ本体側を有効にします。<br>
		この仕組みにより、本体に漢字ROMが搭載されていても、SLOTに漢字ROMを1つだけ装着できるようになりました。<br>
		漢字ROMカートリッジで後付けした方が、本体側漢字ROMよりも優先になるため、本体の漢字フォントが気に入らなければ、<br>
		好きな漢字フォントの漢字ROMカートリッジを装着することで、フォントを変更できるようになっているわけです。<br>
		<br>
		しかし、この仕様は不完全なため、複数のSLOTにそれぞれ漢字ROMカートリッジを装着すると、やはりバス競合が発生します。<br>
		<br>
		Panasonic の FS-A1GT は、この問題の回避策として、漢字ROMのアクセスはカートリッジスロットには出さず、常に本体側漢字ROM<br>
		が有効になるように、信号をブロックする回路が実装されているようです。<br>
		好きなフォントに切り替えられる仕組みはなくなってしまっていますが、A1GTの方が「安全な構成」と言えるのでは無いでしょうか。<br>
		SLOTに漢字ROMカートリッジを搭載しても、無視されます。<br>
		同じ turboR である FS-A1ST にはこの回路は無いようです。<br>
		<br>
		ただ、FS-A1GTのころには、漢字ROM搭載の新しいカートリッジなど無かったと思いますので、A1GTになってから対策を入れるというのも不自然。<br>
		「(おそらく)カートリッジタイプの漢字ROMは遅い」ので、内蔵の高速な漢字ROM限定にした、と考えるのが自然かもしれませんね。<br>
		<br>
		もし、FS-A1STユーザーで、外付け漢字ROMを高速モードで使ったときに、文字化けするような症状を確認できた場合、お知らせいただけると嬉しいです。<br>
		<br>
		≪ FS-A1GTに漢字ROM搭載カートリッジを装着した場合としない場合のKanjiBASICの表示 ≫<br>
		<a href="https://twitter.com/thara1129/status/1442833555709587467">Twitter</a><br>
		HBI-J1 は、MSX-JE + KanjiBASIC + 漢字ROM(JIS1,JIS2) の統合カートリッジですが、A1GTに装着しても漢字フォントが変わらないことが確認できます。<br>
		<br>
		<a href="https://twitter.com/thara1129/status/1442835474012205060">Twitter</a><br>
		HBI-J1 の漢字フォントはこちらで確認できますね。「漢」の字の形状が明らかに違います。<br>
		<br>
		<a href="https://twitter.com/AquaLefty/status/1443365438805577730">Twitter</a><br>
		FS-A1GTに追加されているブロック回路。これのおかげで、SLOTに漢字ROMアクセスの信号が出ていかなくなっているようです。<br>
		<br>
		<a href="https://twitter.com/AquaLefty/status/1443368651046862849">Twitter</a><br>
		<a href="https://twitter.com/yoshimatsuTUQ/status/1443399392665292800">Twitter</a><br>
		FS-A1STには無いようです。<br>
		<br>
		<hr>
		≪ 漢字ROMアクセスブロック回路 ≫<br>
		<a href="./image/kanji_block.png"><img width=240 src="image/kanji_block.png"></a><br>
		<br>
		漢字ROMのI/Oは D8h, D9h, DAh, DBh なので<br>
		　D8h = 11011000<br>
		　D9h = 11011001<br>
		　DAh = 11011010<br>
		　DBh = 11011011<br>
		これを一網打尽に検出するには、0でも1でもどちらでもいいbitをXにすると<br>
		　110110XX<br>
		です。<br>
		<br>
		信号の行き先を確認してみます。<br>
		<a href="./image/kanji_block_mark.png"><img width=240 src="image/kanji_block_mark.png"></a><br>
		まず、マルで囲った部分によって IOREQ# がマスクされるのがわかります。<br>
		<br>
		IC43 の出力は、 ~(~(A7 & A6 & A4 & /M1)) & ~A5 となっています。<br>
		少し変形すると、(A7 & A6 & ~A5 & A4 & /M1) なので、/M1 が 1 で { A7,A6,A5,A4 } = 4'b1101 のときに 1 です。仮にKMASKと名付けます。<br>
		IC33 は、~(~KMASK & ~/IOREQ) なので、ドモルガンの定理で KMASK | /IOREQ と等価です。<br>
		これが SLOT の /IOREQ に繋がるわけですから、KMASK = 1 の時に SLOT の /IOREQ は無効を示す 1 になるわけです。<br>
		0xD0～0xDFのアクセスは、/IOREQがカートリッジスロットに出てこない構造になっているということですね。<br>
		<br>
		なかなか面白いですね。<br>
		<br>
		2021年10月03日 更新<br>
		<a href="./body.html">[戻る]</a><br>
	</body>
</html>
